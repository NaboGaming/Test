<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
</head>
<body>
    <h1>Welcome to the User Dashboard</h1>
    <p>Please select your squad and enter your game name to submit.</p>

    <div>
        <label for="gameName">Game Name:</label>
        <input type="text" id="gameName">
    </div>

    <div>
        <label for="squadSelect">Select Your Squad:</label>
        <select id="squadSelect">
            <option value="squad1">Squad 1</option>
            <option value="squad2">Squad 2</option>
            <option value="squad3">Squad 3</option>
            <option value="squad4">Squad 4</option>
        </select>
        <button id="submitSquadBtn">Submit</button>
    </div>

    <div>
        <h2>Squad Counts</h2>
        <p>Squad 1 <span id="squad1Count">(0/4)</span></p>
        <p>Squad 2 <span id="squad2Count">(0/4)</span></p>
        <p>Squad 3 <span id="squad3Count">(0/4)</span></p>
        <p>Squad 4 <span id="squad4Count">(0/4)</span></p>
    </div>


    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-realtime-database.js";

        const firebaseConfig = {
            // Your Firebase config here
            apiKey: "AIzaSyC_VKdV-KsIzUiOb7jFLsYXdTsuGkLiS-Q",
      authDomain: "register-71bde.firebaseapp.com",
      projectId: "register-71bde",
      storageBucket: "register-71bde.appspot.com",
      messagingSenderId: "412548441298",
      appId: "1:412548441298:web:e0fb2b6c5fbd4af7d0b90b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const realtimeDb = getDatabase(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const squadSelect = document.getElementById("squadSelect");
                const submitSquadBtn = document.getElementById("submitSquadBtn");

                // Function to get the current count of users in each squad
                const updateSquadCounts = () => {
                    const squadsRef = ref(realtimeDb, 'squads');
                    get(squadsRef).then((snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            const squadName = childSnapshot.key;
                            const squadCount = childSnapshot.numChildren();
                            document.getElementById(`${squadName}Count`).textContent = `(${squadCount}/4)`;
                        });
                    });
                }

                // Updating the squad counts initially
                updateSquadCounts();

                submitSquadBtn.addEventListener('click', async () => {
                    const selectedSquad = squadSelect.value;
                    const gameName = document.getElementById("gameName").value;

                    const userSquadRef = ref(realtimeDb, `userSquads/${user.uid}`);
                    const userSquadSnapshot = await get(userSquadRef); // Checking if user already selected a squad

                    if (userSquadSnapshot.exists()) {
                        alert("You have already selected a squad.");
                    } else {
                        if (selectedSquad && gameName) {
                            const squadRef = ref(realtimeDb, `squads/${selectedSquad}`);
                            const squadSnapshot = await get(squadRef);

                            if (squadSnapshot.numChildren() >= 4) {
                                alert("The squad is full. Please select another squad.");
                            } else {
                                set(ref(realtimeDb, `userSquads/${user.uid}`), {
                                    selectedSquad: selectedSquad,
                                    gameName: gameName
                                });
                                updateSquadCounts(); // Update the squad counts after a user selects a squad
                                alert("Squad selection and game name submitted successfully!");
                            }
                        } else {
                            alert("Please enter your game name and select a squad before submitting.");
                        }
                    }
                });
            } else {
                // Redirect or handle unauthorized access
            }
        });
    </script>
</body>
</html>