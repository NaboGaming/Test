<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Formation</title>
</head>

<body>
    <h1>Squad Formation Page</h1>
    <div id="squadFormation">
        <input type="text" id="userName" placeholder="Your Name"><br>
        <button onclick="joinSquad()">Join Squad</button>
    </div>

    <div id="customPopup" style="display: none;">
        <h2>Joined Squad Members</h2>
        <ul id="squadMembers"></ul>
        <button onclick="closePopup()">Close</button>
    </div>

    <script defer type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC_VKdV-KsIzUiOb7jFLsYXdTsuGkLiS-Q",
    authDomain: "register-71bde.firebaseapp.com",
    projectId: "register-71bde",
    storageBucket: "register-71bde.appspot.com",
    messagingSenderId: "412548441298",
    appId: "1:412548441298:web:e0fb2b6c5fbd4af7d0b90b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

onAuthStateChanged(getAuth(app), (user) => {
    if (user) {
        setupSquadFormation(user);
    } else {
        displayPopup();
    }
});

function joinSquad() {
    const userName = document.getElementById('userName').value;
    const squadRef = collection(db, 'squads');

    // Check if user already joined a squad
    const query = collection(db, 'squads').where('members', 'array-contains', userName);
    onSnapshot(query, (snapshot) => {
        if (snapshot.size > 0) {
            alert('You have already joined a squad!');
        } else {
            squadRef.get().then((querySnapshot) => {
                if (querySnapshot.size > 0) {
                    const squad = querySnapshot.docs[0];
                    const squadMembers = squad.data().members;
                    if (squadMembers.length < 4) {
                        squadMembers.push(userName);
                        setDoc(doc(db, 'squads', squad.id), { members: squadMembers }, { merge: true });
                    } else {
                        alert('Squad is full. Please join another squad.');
                    }
                } else {
                    setDoc(doc(db, 'squads', 'squad1'), { members: [userName] });
                }
            }).catch((error) => {
                console.error('Error joining squad: ', error);
            });
        }
    });
}

function setupSquadFormation(user) {
    // Function to display user's information
    const updateUserProfile = (user) => {
        const userName = user.displayName;
        const userEmail = user.email;
        const userProfilePicture = user.photoURL;
        document.getElementById("userName").textContent = userName;
        document.getElementById("userEmail").textContent = userEmail;
        document.getElementById("userProfilePicture").src = userProfilePicture;
    };

    updateUserProfile(user);

    const squadRef = collection(db, 'squads');
    const query = collection(db, 'squads');
    onSnapshot(query, (snapshot) => {
        if (!snapshot.empty) {
            let squadMembersList = '';
            snapshot.forEach((doc) => {
                squadMembersList += `<li>${doc.data().members.join(', ')}</li>`;
            });
            document.getElementById('squadMembers').innerHTML = squadMembersList;
        }
    });
}

function displayPopup() {
    const popup = document.getElementById('customPopup');
    popup.style.display = "block";
}

function closePopup() {
    const popup = document.getElementById('customPopup');
    popup.style.display = "none";
}</script>
</body>

</html>